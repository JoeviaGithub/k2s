<!DOCTYPE html>
<html>

<head>
	<title>rtcninja.js</title>
	<meta http-equiv='Content-Type' content='text/html; charset=utf-8' />
	<link rel='stylesheet' type='text/css' href='style.css' media='screen' />
	<link rel='stylesheet' href='alertifyjs/css/alertify.css'>
	<link rel='stylesheet' href='alertifyjs/css/themes/default.css'>

	<script>
		window.localStorage.setItem('debug', '*');
	</script>

	<script src='adapter.debug.js'></script>

	<script src='antiglobal.js'></script>

	<script src='rtcninja.js'></script>
	<!-- <script src='rtcninja-temasys.js'></script> -->

	<!-- alertify -->
	<script src='alertifyjs/alertify.js'></script>

	<script>
		antiglobal();

		window.debug = rtcninja.debug('index.html');
		window.debugerror = rtcninja.debug('index.html:ERROR');
	</script>

	<script>
		document.addEventListener('DOMContentLoaded', function() {
			window.debug = rtcninja.debug('index.html');
			window.debugerror = rtcninja.debug('index.html:ERROR');

			setTimeout(function()
			{
				loadRTC();
			}, 200);
		}, false);


		function loadRTC() {
			rtcninja();

			// NOTE: for testing in console
			setTimeout(function() {
				window.plugin = document.getElementById('ef2fwebrtcplugin');
				if (!window.plugin)
					window.plugin = document.getElementById('plugin0');
			}, 1000);

			if (rtcninja.hasWebRTC()) {
				alertify.success('your browser supports WebRTC');
				startTheParty();
			}
			else {
				alertify.error('your browser does not support WebRTC');
				return;
			}

			// Log media devices.
			// TODO: Hack to avoid Safari+plugin get frozen.
			// setTimeout(function () {
				// if (rtcninja.getMediaDevices) {
				// 	debug('listing available media devices:')

				// 	rtcninja.getMediaDevices(function (devices) {
				// 		var i, len;

				// 		for (i = 0, len = devices.length; i < len; i++) {
				// 			var device = devices[i];

				// 			debug('- media device: [id:%s, kind:%s, label:"%s", facing:"%s", groupId:%s]',
				// 				device.deviceId || device.id, device.kind, device.label, device.facing, device.groupId);
				// 		}
				// 	});
				// } else {
				// 	debugerror('listing available media devices not available');
				// }
			// }, 500);
		}


		function requestPluginInstallation(data) {
			var msg;

			if (data.isIE) {
				msg = 'You browser does not natively support WebRTC. Please press "Download" to install the WebRTC plugin.';
			}
			else if (data.isSafari) {
				msg = 'You browser does not natively support WebRTC. Please press "Download" to install the WebRTC plugin and restart your browser.';
			}

			alertify.confirm('')
				.set('title', 'WebRTC plugin required')
				.set('message', msg)
				.set('labels', {ok:'download', cancel:'cancel'})
				.set('onok', downloadPlugin)
				.set('movable', false)
				.set('closable', false);

			function downloadPlugin() {
				window.open(data.downloadLink, '_blank');

				if (data.isIE) {
					rtcninjaTemasys.monitorPluginInstallation(function() {
						loadRTC();
					});
				}
			}
		}


		function startTheParty() {
			var peerA, peerB;
			var localStream = null;
			var status = 'stopped';  // 'stopped', 'connecting', 'connected'.
			var startStopButton = document.querySelector('#startStopButton');
			var peerAlocalVideo = document.querySelector('#peerA video.local');
			var peerAremoteVideo = document.querySelector('#peerA video.remote');
			var peerBlocalVideo = document.querySelector('#peerB video.local');
			var peerBremoteVideo = document.querySelector('#peerB video.remote');

			startStopButton.classList.add('enabled');
			startStopButton.addEventListener('click', onStartStopButtonClick, false);

			peerAlocalVideo.onloadstart = function () {
				window.debug('peerAlocalVideo onloadstart | [readyState:%d]', peerAlocalVideo.readyState);
			}

			peerAlocalVideo.ondurationchange = function () {
				window.debug('peerAlocalVideo ondurationchange | [readyState:%d]', peerAlocalVideo.readyState);
			}

			peerAlocalVideo.onloadedmetadata = function () {
				window.debug('peerAlocalVideo onloadedmetadata | [readyState:%d]', peerAlocalVideo.readyState);
			}

			peerAlocalVideo.onloadeddata = function () {
				window.debug('peerAlocalVideo onloadeddata | [readyState:%d]', peerAlocalVideo.readyState);
			}

			// peerAlocalVideo.onprogress = function () {
				// window.debug('peerAlocalVideo onprogress | [readyState:%d]', peerAlocalVideo.readyState);
			// }

			peerAlocalVideo.oncanplay = function () {
				window.debug('peerAlocalVideo oncanplay | [readyState:%d]', peerAlocalVideo.readyState);
			}

			peerAlocalVideo.oncanplaythrough = function () {
				window.debug('peerAlocalVideo oncanplaythrough | [readyState:%d]', peerAlocalVideo.readyState);
			}

			peerAlocalVideo.onended = function () {
				window.debug('peerAlocalVideo onended | [readyState:%d]', peerAlocalVideo.readyState);
			}

			peerAremoteVideo.onloadstart = function () {
				window.debug('peerAremoteVideo onloadstart | [readyState:%d]', peerAremoteVideo.readyState);
			}

			peerAremoteVideo.ondurationchange = function () {
				window.debug('peerAremoteVideo ondurationchange | [readyState:%d]', peerAremoteVideo.readyState);
			}

			peerAremoteVideo.onloadedmetadata = function () {
				window.debug('peerAremoteVideo onloadedmetadata | [readyState:%d]', peerAremoteVideo.readyState);
			}

			peerAremoteVideo.onloadeddata = function () {
				window.debug('peerAremoteVideo onloadeddata | [readyState:%d]', peerAremoteVideo.readyState);
			}

			// peerAremoteVideo.onprogress = function () {
				// window.debug('peerAremoteVideo onprogress | [readyState:%d]', peerAremoteVideo.readyState);
			// }

			peerAremoteVideo.oncanplay = function () {
				window.debug('peerAremoteVideo oncanplay | [readyState:%d]', peerAremoteVideo.readyState);
			}

			peerAremoteVideo.oncanplaythrough = function () {
				window.debug('peerAremoteVideo oncanplaythrough | [readyState:%d]', peerAremoteVideo.readyState);
			}

			peerAremoteVideo.onended = function () {
				window.debug('peerAremoteVideo onended | [readyState:%d]', peerAremoteVideo.readyState);
			}

			function onStartStopButtonClick() {
				if (status === 'stopped') {
					start();
				}
				else if (status === 'connected') {
					stop();
				}
			}

			function onConnecting(text) {
				window.debug('onConnecting()');

				status = 'connecting';
				startStopButton.textContent = text || 'connecting ...';
				startStopButton.classList.add('connecting');
			}

			function onConnected() {
				window.debug('onConnected()');

				status = 'connected';
				startStopButton.textContent = 'stop';
				startStopButton.classList.remove('connecting');
				startStopButton.classList.add('connected');
			}

			function onStopped() {
				window.debug('onStopped()');

				status = 'stopped';
				startStopButton.textContent = 'start';
				startStopButton.classList.remove('connecting');
				startStopButton.classList.remove('connected');
				startStopButton.classList.remove('established');
			}

			function onEstablished() {
				window.debug('onEstablished');

				startStopButton.classList.add('established');
			}

			function start() {
				window.debug('start()');

				if (! localStream) {
					onConnecting('requesting media ...');

					rtcninja.getUserMedia(
						{audio:true, video:true},
						function(stream) {
							localStream = stream;
							start();
						},
						function(error) {
							window.debugerror('getUserMedia() failed:', error);
							onStopped();
							throw error;
						}
					);
					return;
				}

				onConnecting();

				var pcConfig = {
					// iceServers: [],
					iceServers: [ {url: 'stun:74.125.132.127:19302'} ],
					// iceServers: [
					// 	{ url:'turn:turn.ef2f.com:3478?transport=udp', username:'turn', credential:'ef2f' },
					// 	{ url:'turn:turn.ef2f.com:3478?transport=tcp', username:'turn', credential:'ef2f' },
					// 	{ url:'turns:turn.ef2f.com:443?transport=tcp', username:'turn', credential:'ef2f' }
					// ],
					// iceServers: [
					// 	{
					// 		urls: [
					// 			'turn:turn.ef2f.com:3478?transport=udp',
					// 			'turn:turn.ef2f.com:3478?transport=tcp',
					// 			'turns:turn.ef2f.com:443?transport=tcp'
					// 		],
					// 		username:'turn',
					// 		credential:'ef2f'
					// 	}
					// ],
					// iceTransports: 'relay',
					gatheringTimeout: 2000,
					gatheringTimeoutAfterRelay: 500
				};

				peerA = new Peer(localStream, pcConfig);
				peerB = new Peer(localStream, pcConfig);

				peerAlocalVideo = rtcninja.attachMediaStream(peerAlocalVideo, localStream);
				peerBlocalVideo = rtcninja.attachMediaStream(peerBlocalVideo, localStream);

				// TMP: expose global variables.
				window.peerA = peerA;
				window.peerB = peerB;
				window.pcA = peerA.connection;
				window.pcB = peerB.connection;
				window.localStream = localStream;
				window.peerAlocalVideo = peerAlocalVideo;

				peerA.connection.onicecandidate = function(event) {
					if (! event.candidate) { return; }
					peerB.connection.addIceCandidate(event.candidate);
				};

				peerB.connection.onicecandidate = function(event) {
					if (! event.candidate) { return; }
					peerA.connection.addIceCandidate(event.candidate);
				};

				peerA.connection.onaddstream = function(event) {
					peerAremoteVideo = rtcninja.attachMediaStream(peerAremoteVideo, event.stream);
				};

				peerB.connection.onaddstream = function(event) {
					peerBremoteVideo = rtcninja.attachMediaStream(peerBremoteVideo, event.stream);
				};

				peerA.call(
					// success
					function(offer) {
						peerB.answer(offer,
							// success
							function(answer) {
								peerA.connection.setRemoteDescription(answer);
								onConnected();
								peerB.connection.oniceconnectionstatechange = function(event, state) {
									if (state === 'connected' || state === 'completed') {
										onEstablished();
									}
								}
							},
							// failure
							function(error) {
								window.debugerror('PeerB.answer() failed: ', error);
								onStopped();
								throw error;
							}
						);
					},
					// failure
					function(error) {
						window.debugerror('PeerA.call() failed: ', error);
						onStopped();
						throw error;
					}
				);
			}

			function stop() {
				window.debug('stop()');

				onStopped();

				if (peerA) {
					peerA.connection.close();
					peerB.connection.close();
				}

				// TODO: Uncomment
				// if (localStream) {
				// 	rtcninja.closeMediaStream(localStream);
				// 	localStream = null;
				// }

				// TODO: This does not work with the Temasys plugin.
				// peerAlocalVideo.src = '';
				// peerAremoteVideo.src = '';
				// peerBlocalVideo.src = '';
				// peerBremoteVideo.src = '';
			}


			// Peer class.
			function Peer(stream, configuration) {
				// Create rtcninja.RTCPeerConnection.
				this.connection = new rtcninja.RTCPeerConnection(configuration);

				// Attach local stream.
				this.connection.addStream(stream);
			}

			Peer.prototype.call = function(callback, errback) {
				var self = this;

				this.connection.createOffer(
					// success
					function(offer) {
						self.connection.setLocalDescription(offer,
							// success
							function() {
								window.debug('Peer#call() | SDP offer: %o', self.connection.localDescription.sdp);
								callback(self.connection.localDescription);
							},
							// failure
							errback
						);
					},
					// failure
					errback,
					// RTCOfferConstraints
					{
						offerToReceiveAudio: 1,
						offerToReceiveVideo: 1
					}
				);
			};

			Peer.prototype.answer = function(offer, callback, errback) {
				var self = this;

				this.connection.setRemoteDescription(offer,
					// success
					function() {
						self.connection.createAnswer(
							// success
							function(answer) {
								self.connection.setLocalDescription(answer,
									// success
									function() {
										window.debug('Peer#answer() | SDP answer: %o', self.connection.localDescription.sdp);
										callback(self.connection.localDescription);
									},
									// failure
									errback
								);
							},
							// failure
							errback
						);
					},
					// failure
					errback
				);
			};
		}
	</script>
</head>

<body>

	<div class='header'></div>

	<div class='videos'>
		<div id='peerA' class='peerVideo'>
			<p class='remote'>peer B</p>
			<p class='local'>peer A</p>
			<video class='remote' autoplay></video>
			<video class='local' autoplay muted='true'></video>
		</div>

		<div class='space'></div>

		<div id='peerB' class='peerVideo'>
			<p class='remote'>peer A</p>
			<p class='local'>peer B</p>
			<video class='remote' autoplay></video>
			<video class='local' autoplay muted='true'></video>
		</div>
	</div>

	<div id='startStopButton'>start</div>
</body>

</html>
